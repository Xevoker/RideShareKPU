<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Find a Ride – RideShare</title>
  <link rel="stylesheet" href="../CSS/find.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-container">
      <img src="../images/a.jpg" class="logo-img" alt="Logo" />
      <h2>Ride<span>Share</span></h2>
    </div>
    <nav>
      <ul>
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="ride history.html">My Rides</a></li>
        <li><a href="messages.html">Messages</a></li>
        <li><a href="offer.html">Offer Ride</a></li>
        <li><a href="find.html" class="active">Find Ride</a></li>
        <li><a href="settings.html">Settings</a></li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <h1>Find a Ride</h1>
      <div class="header-actions">
        <button class="btn-notify" title="Notifications"><i class="fas fa-bell"></i></button>
        <img src="../images/a.jpg" class="user-avatar" alt="User Avatar" />
      </div>
    </header>

    <section class="search-section">
      <p>Search for available rides offered by fellow KPU students. Enter a starting point, destination, or time to filter.</p>
      <div class="search-bar">
        <input type="text" id="searchLocation" placeholder="Search by start or destination..." />
        <input type="time" id="searchTime" />
        <button id="searchBtn"><i class="fas fa-search"></i> Search</button>
      </div>
    </section>

    <section class="rides-list" id="ridesList">
      <!-- rides will be injected here -->
    </section>
  </main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ✅ use saved profile name
  let currentUserName = "Guest";
  const savedProfile = JSON.parse(localStorage.getItem("rideShareProfile"));
  if (savedProfile && savedProfile.fullName) {
    currentUserName = savedProfile.fullName;
  } else {
    const savedSession = JSON.parse(localStorage.getItem("rideShareSession"));
    if (savedSession && savedSession.username) {
      currentUserName = savedSession.username;
    }
  }

  const ridesList = document.getElementById("ridesList");
  const searchLocationInput = document.getElementById("searchLocation");
  const searchTimeInput = document.getElementById("searchTime");
  const searchBtn = document.getElementById("searchBtn");

  // Load from storage
  let rides = JSON.parse(localStorage.getItem("rides") || "[]");
  let joinedRideIds = JSON.parse(localStorage.getItem("joinedRideIds") || "[]");

  function saveRides() {
    localStorage.setItem("rides", JSON.stringify(rides));
  }
  function saveJoinedRideIds() {
    localStorage.setItem("joinedRideIds", JSON.stringify(joinedRideIds));
  }

  // Display rides
  function displayRides(list) {
    ridesList.innerHTML = "";
    if (list.length === 0) {
      ridesList.innerHTML = `<p style="color:#990000;font-weight:600;">No rides found.</p>`;
      return;
    }
    list.forEach((ride) => {
      const joinedThisRide = joinedRideIds.includes(ride.id);
      const rideCard = document.createElement("div");
      rideCard.className = "ride-card";
      rideCard.innerHTML = `
        <h3>${ride.from} ➡️ ${ride.to}</h3>
        <p><strong>Date:</strong> ${ride.date}</p>
        <p><strong>Time:</strong> ${ride.time}</p>
        <p><strong>Seats:</strong> ${ride.seats}</p>
        ${ride.notes ? `<p><strong>Notes:</strong> ${ride.notes}</p>` : ""}
        <p class="posted-time"><em>Posted at: ${ride.postedAt || 'N/A'}</em></p>
        <button class="btn-join" data-id="${ride.id}"
          ${joinedThisRide || ride.seats <= 0 ? "disabled" : ""}>
          ${joinedThisRide ? "Joined" : (ride.seats <= 0 ? "Full" : "Join Ride")}
        </button>
      `;
      ridesList.appendChild(rideCard);
    });
  }

  // Initial render
  displayRides(rides);

  // Filter
  searchBtn.addEventListener("click", () => {
    const locationQuery = searchLocationInput.value.toLowerCase();
    const timeQuery = searchTimeInput.value.trim();
    const filtered = rides.filter(r => {
      const matchesLocation = r.from.toLowerCase().includes(locationQuery) ||
                              r.to.toLowerCase().includes(locationQuery);
      const matchesTime = timeQuery === "" || r.time === timeQuery;
      return matchesLocation && matchesTime;
    });
    displayRides(filtered);
  });

  // Join ride
  ridesList.addEventListener("click", (e) => {
    if (e.target.classList.contains("btn-join") && !e.target.disabled) {
      const rideId = e.target.dataset.id;
      const rideIndex = rides.findIndex(r => r.id === rideId);
      if (rideIndex === -1) return;

      const ride = rides[rideIndex];

      if (joinedRideIds.includes(rideId)) {
        alert("You have already joined this ride.");
        return;
      }

      if (ride.seats > 0) {
        ride.seats = Number(ride.seats) - 1;

        if (!ride.passengers) ride.passengers = [];
        if (!ride.passengers.includes(currentUserName)) {
          ride.passengers.push(currentUserName);
        }

        joinedRideIds.push(rideId);
        saveJoinedRideIds();
        saveRides();

        const now = new Date().toISOString();
        let activities = JSON.parse(localStorage.getItem("rideShareActivities") || "[]");
        activities.unshift({ text: `You joined a ride: ${ride.from} ➡ ${ride.to} on ${ride.date}`, date: now });
        if (activities.length > 20) activities.pop();
        localStorage.setItem("rideShareActivities", JSON.stringify(activities));

        alert(`You joined the ride from ${ride.from} to ${ride.to}!`);
        window.location.href = "dashboard.html"; // ✅ redirect after joining
      } else {
        alert("Sorry, no seats left for this ride!");
      }
    }
  });
});
</script>
</body>
</html>
